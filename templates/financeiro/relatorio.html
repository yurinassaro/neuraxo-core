{% extends 'base.html' %}

{% block title %}Relatório Financeiro - NeuraxoCore{% endblock %}

{% block content %}
<div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-gray-800">Relatório Financeiro</h1>
    <a href="{% url 'dashboard_financeiro' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">Voltar</a>
</div>

<!-- Filtros -->
<div class="bg-white rounded-lg shadow p-4 mb-6">
    <form method="get" class="flex flex-wrap items-end gap-4">
        <div>
            <label class="block text-xs text-gray-500 mb-1">Empresa</label>
            <select name="empresa" class="px-3 py-2 border rounded-lg text-sm">
                {% for e in empresas %}
                <option value="{{ e.id }}" {% if empresa.id == e.id %}selected{% endif %}>{{ e.nome }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs text-gray-500 mb-1">Mês</label>
            <select name="mes" class="px-3 py-2 border rounded-lg text-sm">
                {% for m in "xxxxxxxxxxxx" %}{% if forloop.counter <= 12 %}
                <option value="{{ forloop.counter }}" {% if forloop.counter == mes %}selected{% endif %}>{{ forloop.counter|stringformat:"02d" }}</option>
                {% endif %}{% endfor %}
            </select>
        </div>
        <div>
            <label class="block text-xs text-gray-500 mb-1">Ano</label>
            <input type="number" name="ano" value="{{ ano }}" class="px-3 py-2 border rounded-lg text-sm w-24">
        </div>
        <button type="submit" class="px-4 py-2 bg-gray-700 text-white rounded-lg text-sm hover:bg-gray-800">Gerar</button>
    </form>
</div>

{% if not empresa %}
<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
    <p class="text-yellow-700">Nenhuma empresa cadastrada.</p>
</div>
{% else %}

<!-- Resumo geral -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-xs text-gray-400">Receita Total</p>
        <p class="text-xl font-bold text-green-600">R$ {{ total_entradas|floatformat:2 }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-xs text-gray-400">Saídas Total</p>
        <p class="text-xl font-bold text-red-600">R$ {{ total_saidas|floatformat:2 }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center">
        <p class="text-xs text-gray-400">Custos Operacionais</p>
        <p class="text-xl font-bold text-orange-600">R$ {{ custos_operacionais_total|floatformat:2 }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4 text-center border-2 {% if lucro_liquido >= 0 %}border-green-300{% else %}border-red-300{% endif %}">
        <p class="text-xs text-gray-400">Lucro Líquido</p>
        <p class="text-2xl font-bold {% if lucro_liquido >= 0 %}text-green-600{% else %}text-red-600{% endif %}">R$ {{ lucro_liquido|floatformat:2 }}</p>
    </div>
</div>

<!-- Divisão Sócios (apenas ANAC) -->
{% if empresa.nome == "Anac" %}
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-700 mb-4">Divisão entre Sócios (50/50)</h2>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div class="bg-gray-50 rounded-lg p-4 text-center">
            <p class="text-xs text-gray-400">Direito de cada</p>
            <p class="text-2xl font-bold text-gray-800">R$ {{ direito_cada|floatformat:2 }}</p>
        </div>
        <!-- Renan -->
        <div class="bg-red-50 rounded-lg p-4">
            <p class="text-xs text-red-400 mb-2">RENAN</p>
            <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Retiradas brutas</span>
                    <span class="font-semibold">R$ {{ retirada_renan|floatformat:2 }}</span>
                </div>
                {% if prestacoes_renan %}
                <div class="flex justify-between text-blue-600">
                    <span>(-) Pagou pela empresa</span>
                    <span class="font-semibold">R$ {{ prestacoes_renan|floatformat:2 }}</span>
                </div>
                {% endif %}
                <div class="flex justify-between border-t pt-1">
                    <span class="text-gray-600">Retirada pessoal</span>
                    <span class="font-bold">R$ {{ retirada_renan_liquida|floatformat:2 }}</span>
                </div>
                <div class="flex justify-between border-t pt-1 mt-1">
                    <span class="text-gray-600">Saldo</span>
                    <span class="font-bold text-lg {% if saldo_renan > 0 %}text-green-600{% elif saldo_renan < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                        {% if saldo_renan > 0 %}Pode tirar R$ {{ saldo_renan|floatformat:2 }}{% elif saldo_renan < 0 %}Tirou a mais R$ {{ saldo_renan|floatformat:2 }}{% else %}Zerado{% endif %}
                    </span>
                </div>
            </div>
        </div>
        <!-- Yuri -->
        <div class="bg-blue-50 rounded-lg p-4">
            <p class="text-xs text-blue-400 mb-2">YURI</p>
            <div class="space-y-1 text-sm">
                <div class="flex justify-between">
                    <span class="text-gray-600">Retiradas</span>
                    <span class="font-semibold">R$ {{ retirada_yuri|floatformat:2 }}</span>
                </div>
                {% for r in retiradas_yuri_detalhe %}
                <div class="flex justify-between pl-3 text-xs text-gray-400">
                    <span>{{ r.data|date:"d/m" }} - {{ r.descricao|truncatechars:30 }}</span>
                    <span>R$ {{ r.valor|floatformat:2 }}</span>
                </div>
                {% endfor %}
                <div class="flex justify-between border-t pt-1 mt-1">
                    <span class="text-gray-600">Saldo</span>
                    <span class="font-bold text-lg {% if saldo_yuri > 0 %}text-green-600{% elif saldo_yuri < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                        {% if saldo_yuri > 0 %}Pode tirar R$ {{ saldo_yuri|floatformat:2 }}{% elif saldo_yuri < 0 %}Tirou a mais R$ {{ saldo_yuri|floatformat:2 }}{% else %}Zerado{% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Registrar pagamento recebido -->
    <div class="mt-4 bg-indigo-50 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-indigo-700 mb-3">Registrar Pagamento Recebido</h3>
        <p class="text-xs text-gray-500 mb-3">Use quando o Renan te pagar por fora (Pix pessoal, dinheiro, transferência). Não afeta saldo do MP.</p>
        <form method="post" action="{% url 'registrar_retirada' %}" class="flex flex-wrap items-end gap-3">
            {% csrf_token %}
            <input type="hidden" name="empresa" value="{{ empresa.id }}">
            <input type="hidden" name="mes" value="{{ mes }}">
            <input type="hidden" name="ano" value="{{ ano }}">
            <div class="flex-1 min-w-[150px]">
                <label class="block text-xs text-gray-500 mb-1">Valor (R$)</label>
                <input type="text" name="valor" required placeholder="1.500,00" class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <div class="flex-1 min-w-[150px]">
                <label class="block text-xs text-gray-500 mb-1">Data</label>
                <input type="date" name="data" required class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <div class="flex-[2] min-w-[200px]">
                <label class="block text-xs text-gray-500 mb-1">Descrição</label>
                <input type="text" name="descricao" required placeholder="Ex: Pix do Renan ref. janeiro" class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">Registrar</button>
        </form>
    </div>
</div>
{% endif %}

<!-- Detalhamento por categoria -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    <!-- Entradas -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-sm font-semibold text-gray-500 mb-3">RECEITAS POR CATEGORIA</h2>
        {% for c in cat_entradas %}
        <div class="flex items-center justify-between py-2 border-b last:border-0">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full" style="background:{{ c.categoria__cor|default:'#22c55e' }}"></span>
                <span class="text-sm">{{ c.categoria__nome|default:"Sem categoria" }}</span>
                <span class="text-xs text-gray-400">({{ c.qtd }}x)</span>
            </div>
            <span class="text-sm font-semibold text-green-600">R$ {{ c.total|floatformat:2 }}</span>
        </div>
        {% empty %}
        <p class="text-sm text-gray-400">Nenhuma receita no período</p>
        {% endfor %}
        <div class="flex justify-between pt-3 mt-2 border-t-2 border-green-200">
            <span class="font-bold text-sm">Total Receitas</span>
            <span class="font-bold text-green-600">R$ {{ total_entradas|floatformat:2 }}</span>
        </div>
    </div>

    <!-- Saídas -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-sm font-semibold text-gray-500 mb-3">DESPESAS POR CATEGORIA</h2>
        {% for c in cat_saidas %}
        <div class="flex items-center justify-between py-2 border-b last:border-0">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full" style="background:{{ c.categoria__cor|default:'#ef4444' }}"></span>
                <span class="text-sm">{{ c.categoria__nome|default:"Sem categoria" }}</span>
                <span class="text-xs text-gray-400">({{ c.qtd }}x)</span>
            </div>
            <span class="text-sm font-semibold text-red-600">R$ {{ c.total|floatformat:2 }}</span>
        </div>
        {% empty %}
        <p class="text-sm text-gray-400">Nenhuma despesa no período</p>
        {% endfor %}
        <div class="flex justify-between pt-3 mt-2 border-t-2 border-red-200">
            <span class="font-bold text-sm">Total Despesas</span>
            <span class="font-bold text-red-600">R$ {{ total_saidas|floatformat:2 }}</span>
        </div>
    </div>
</div>

<!-- Prestações de conta do Renan -->
{% if prestacoes_detalhe %}
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-sm font-semibold text-gray-500 mb-3">GASTOS EMPRESA PAGOS PELO RENAN (Prestação de Contas)</h2>
    <p class="text-xs text-gray-400 mb-3">Estes valores já estão descontados da retirada pessoal do Renan e somados nos custos operacionais.</p>
    <table class="w-full text-sm">
        <thead class="text-left text-gray-400 border-b">
            <tr>
                <th class="py-2">Data Retirada</th>
                <th>Descrição</th>
                <th>Categoria</th>
                <th class="text-right">Valor</th>
            </tr>
        </thead>
        <tbody>
            {% for p in prestacoes_detalhe %}
            <tr class="border-b last:border-0">
                <td class="py-2">{{ p.lancamento.data|date:"d/m/Y" }}</td>
                <td>{{ p.descricao }}</td>
                <td>
                    {% if p.categoria %}
                    <span class="px-2 py-0.5 rounded text-xs text-white" style="background:{{ p.categoria.cor }}">{{ p.categoria.nome }}</span>
                    {% else %}-{% endif %}
                </td>
                <td class="text-right font-semibold text-blue-600">R$ {{ p.valor|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

<!-- DRE simplificado -->
<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h2 class="text-sm font-semibold text-gray-500 mb-4">DEMONSTRATIVO - {{ mes|stringformat:"02d" }}/{{ ano }}</h2>
    <div class="space-y-2 text-sm max-w-lg">
        <div class="flex justify-between py-1">
            <span class="text-gray-600">Receita Total</span>
            <span class="font-semibold text-green-600">R$ {{ total_entradas|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between py-1 pl-4 text-gray-500">
            <span>(-) Custos operacionais (diretos)</span>
            <span class="text-red-500">R$ {{ custos_operacionais|floatformat:2 }}</span>
        </div>
        {% if empresa.nome == "Anac" and prestacoes_renan %}
        <div class="flex justify-between py-1 pl-4 text-gray-500">
            <span>(-) Gastos via Renan (prestação)</span>
            <span class="text-red-500">R$ {{ prestacoes_renan|floatformat:2 }}</span>
        </div>
        {% endif %}
        <div class="flex justify-between py-2 border-t-2 border-gray-300 font-bold">
            <span>= Lucro Líquido</span>
            <span class="{% if lucro_liquido >= 0 %}text-green-600{% else %}text-red-600{% endif %}">R$ {{ lucro_liquido|floatformat:2 }}</span>
        </div>
        {% if empresa.nome == "Anac" %}
        <div class="flex justify-between py-1 pl-4 text-gray-500">
            <span>Direito Renan (50%)</span>
            <span>R$ {{ direito_cada|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between py-1 pl-4 text-gray-500">
            <span>Direito Yuri (50%)</span>
            <span>R$ {{ direito_cada|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between py-1 pl-6 text-gray-400">
            <span>Renan já retirou (líquido)</span>
            <span>R$ {{ retirada_renan_liquida|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between py-1 pl-6 text-gray-400">
            <span>Yuri já retirou</span>
            <span>R$ {{ retirada_yuri|floatformat:2 }}</span>
        </div>
        <div class="flex justify-between py-2 border-t-2 border-indigo-300">
            <span class="font-bold text-blue-700">Yuri tem a receber</span>
            <span class="font-bold text-lg {% if saldo_yuri > 0 %}text-green-600{% else %}text-red-600{% endif %}">R$ {{ saldo_yuri|floatformat:2 }}</span>
        </div>
        {% endif %}
    </div>
</div>

{% endif %}
{% endblock %}
