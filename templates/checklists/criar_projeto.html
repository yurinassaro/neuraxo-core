{% extends 'base.html' %}

{% block title %}Novo Projeto - NeuraxoCore{% endblock %}

{% block content %}
<div class="mb-6">
    <a href="{% url 'lista_projetos' %}" class="text-indigo-600 hover:underline">&larr; Voltar para projetos</a>
</div>

<div class="bg-white rounded-lg shadow p-6 max-w-2xl">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Novo Projeto</h1>

    <form method="post" class="space-y-6">
        {% csrf_token %}

        <!-- Template (opcional) -->
        <div class="bg-indigo-50 border border-indigo-200 rounded-lg p-4">
            <label class="block text-sm font-medium text-indigo-700 mb-2">Usar Template (opcional)</label>
            <select name="template" id="template" class="w-full px-4 py-2 border border-indigo-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none bg-white">
                <option value="">Criar projeto em branco...</option>
                {% if templates_globais %}
                <optgroup label="Templates Globais">
                    {% for t in templates_globais %}
                    <option value="global_{{ t.id }}" data-cor="{{ t.cor }}" data-etapas="{{ t.get_total_etapas }}">{{ t.titulo }} ({{ t.get_total_etapas }} etapas)</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
                {% if templates %}
                <optgroup label="Templates Locais">
                    {% for t in templates %}
                    <option value="{{ t.id }}" data-cor="{{ t.cor }}" data-etapas="{{ t.get_total_etapas }}">{{ t.titulo }} ({{ t.get_total_etapas }} etapas)</option>
                    {% endfor %}
                </optgroup>
                {% endif %}
            </select>
            <p class="text-xs text-indigo-600 mt-1">Selecione um template para criar o projeto com etapas pré-definidas</p>

            <div id="template-info" class="hidden mt-3 p-3 bg-white rounded border border-indigo-200">
                <div class="flex items-center justify-between">
                    <span class="text-sm text-gray-600">Este template possui <strong id="template-etapas">0</strong> etapas</span>
                    <div class="flex items-center space-x-2">
                        <label class="text-xs text-gray-500">Dias por etapa:</label>
                        <input type="number" name="dias_por_etapa" value="7" min="1" max="30" class="w-16 px-2 py-1 border rounded text-sm focus:ring-1 focus:ring-indigo-500">
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Empresa *</label>
                <select name="empresa" id="empresa" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option value="">Selecione...</option>
                    {% for emp in empresas %}
                    <option value="{{ emp.id }}">{{ emp.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
                <select name="cliente" id="cliente" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option value="">Sem cliente...</option>
                    {% for c in clientes %}
                    <option value="{{ c.id }}">{{ c.nome }}{% if c.tipo == 'pj' %} (PJ){% endif %}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Responsável</label>
                <select name="responsavel" id="responsavel" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    <option value="">Selecione...</option>
                    {% for p in pessoas %}
                    <option value="{{ p.id }}">{{ p.nome }}{% if p.cargo %} ({{ p.cargo.nome }}){% endif %}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Prazo</label>
                <input type="date" name="prazo" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Título *</label>
            <input type="text" name="titulo" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Ex: Ailote - Sistema de Loteamentos">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
            <textarea name="descricao" rows="3" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="Objetivos e escopo do projeto..."></textarea>
        </div>

        <!-- Participantes -->
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Participantes</label>
            <div id="participantes-container" class="border rounded-lg p-3 max-h-48 overflow-y-auto space-y-2 bg-gray-50">
                <p class="text-sm text-gray-400">Selecione uma empresa primeiro...</p>
            </div>
            <p class="text-xs text-gray-500 mt-1">Selecione as pessoas que participarão do projeto</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select name="status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:outline-none">
                    {% for value, label in status_choices %}
                    <option value="{{ value }}" {% if value == 'planejamento' %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Cor</label>
                <input type="color" name="cor" id="cor-input" value="#6366f1" class="w-full h-10 border rounded-lg cursor-pointer">
            </div>
        </div>

        <div class="flex justify-end space-x-3">
            <a href="{% url 'lista_projetos' %}" class="px-6 py-2 text-gray-600 hover:text-gray-800">Cancelar</a>
            <button type="submit" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">Criar Projeto</button>
        </div>
    </form>
</div>

<script>
const empresaSelect = document.getElementById('empresa');
const responsavelSelect = document.getElementById('responsavel');
const participantesContainer = document.getElementById('participantes-container');
const templateSelect = document.getElementById('template');
const templateInfo = document.getElementById('template-info');
const templateEtapas = document.getElementById('template-etapas');
const corInput = document.getElementById('cor-input');

empresaSelect.addEventListener('change', function() {
    const empresaId = this.value;
    if (!empresaId) {
        responsavelSelect.innerHTML = '<option value="">Selecione uma empresa primeiro...</option>';
        participantesContainer.innerHTML = '<p class="text-sm text-gray-400">Selecione uma empresa primeiro...</p>';
        return;
    }
    fetch(`/pessoas/${empresaId}/`)
        .then(response => response.json())
        .then(data => {
            responsavelSelect.innerHTML = '<option value="">Selecione...</option>';
            participantesContainer.innerHTML = '';
            data.pessoas.forEach(p => {
                const cargo = p.cargo ? ` (${p.cargo})` : '';
                responsavelSelect.innerHTML += `<option value="${p.id}">${p.nome}${cargo}</option>`;
                participantesContainer.innerHTML += `
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" name="participantes" value="${p.id}" class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                        <span class="text-sm text-gray-700">${p.nome}${cargo}</span>
                    </label>`;
            });
            if (data.pessoas.length === 0) {
                participantesContainer.innerHTML = '<p class="text-sm text-gray-400">Nenhuma pessoa nesta empresa</p>';
            }
        });
});

templateSelect.addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    if (this.value) {
        templateInfo.classList.remove('hidden');
        templateEtapas.textContent = option.dataset.etapas;
        if (option.dataset.cor) {
            corInput.value = option.dataset.cor;
        }
    } else {
        templateInfo.classList.add('hidden');
        corInput.value = '#6366f1';
    }
});
</script>
{% endblock %}
