{% extends 'base.html' %}

{% block title %}DRE Simplificado - NeuraxoCore{% endblock %}

{% block content %}
<div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-gray-800">DRE Simplificado</h1>
    <div class="flex items-center gap-3">
        <form method="get" class="flex items-center gap-2">
            <select name="empresa" onchange="this.form.submit()" class="px-3 py-2 border rounded-lg text-sm">
                {% for e in empresas %}
                <option value="{{ e.id }}" {% if empresa.id == e.id %}selected{% endif %}>{{ e.nome }}</option>
                {% endfor %}
            </select>
            <select name="mes" class="px-3 py-2 border rounded-lg text-sm">
                {% for m in meses_disponiveis %}
                <option value="{{ m.month }}" data-ano="{{ m.year }}" {% if m.month == mes and m.year == ano %}selected{% endif %}>
                    {{ m|date:"m/Y" }}
                </option>
                {% empty %}
                <option value="{{ mes }}">{{ mes|stringformat:"02d" }}/{{ ano }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="ano" id="ano-input" value="{{ ano }}">
            <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 text-sm">Filtrar</button>
        </form>
        <a href="{% url 'dashboard_financeiro' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">Voltar</a>
    </div>
</div>

{% if empresa %}

<!-- Comparativo Rapido -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500">Receita vs Mes Anterior</p>
                <p class="text-2xl font-bold text-gray-800">R$ {{ receita_bruta|floatformat:2 }}</p>
            </div>
            <div class="text-right">
                <span class="text-sm {% if variacao_receita >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-bold">
                    {% if variacao_receita >= 0 %}+{% endif %}{{ variacao_receita|floatformat:1 }}%
                </span>
                <p class="text-xs text-gray-400">Anterior: R$ {{ receita_anterior|floatformat:2 }}</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-sm text-gray-500">Lucro vs Mes Anterior</p>
                <p class="text-2xl font-bold {% if lucro_liquido >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                    R$ {{ lucro_liquido|floatformat:2 }}
                </p>
            </div>
            <div class="text-right">
                <span class="text-sm {% if variacao_lucro >= 0 %}text-green-600{% else %}text-red-600{% endif %} font-bold">
                    {% if variacao_lucro >= 0 %}+{% endif %}{{ variacao_lucro|floatformat:1 }}%
                </span>
                <p class="text-xs text-gray-400">Anterior: R$ {{ lucro_anterior|floatformat:2 }}</p>
            </div>
        </div>
    </div>
</div>

<!-- DRE -->
<div class="bg-white rounded-lg shadow overflow-hidden mb-6">
    <div class="p-4 border-b bg-gray-50">
        <h2 class="text-lg font-semibold text-gray-700">
            Demonstrativo de Resultado - {{ mes|stringformat:"02d" }}/{{ ano }}
        </h2>
    </div>
    <div class="p-6">
        <table class="w-full">
            <tbody class="divide-y">
                <!-- Receita Bruta -->
                <tr class="hover:bg-gray-50">
                    <td class="py-3 font-semibold text-gray-800">RECEITA BRUTA</td>
                    <td class="py-3 text-right font-bold text-green-600 text-lg">R$ {{ receita_bruta|floatformat:2 }}</td>
                </tr>
                <!-- Deducoes -->
                <tr class="hover:bg-gray-50">
                    <td class="py-3 pl-4 text-gray-600">(-) Deducoes (Taxas, Impostos)</td>
                    <td class="py-3 text-right text-red-600">- R$ {{ deducoes|floatformat:2 }}</td>
                </tr>
                <!-- Receita Liquida -->
                <tr class="bg-blue-50 hover:bg-blue-100">
                    <td class="py-3 font-semibold text-blue-800">= RECEITA LIQUIDA</td>
                    <td class="py-3 text-right font-bold text-blue-800 text-lg">R$ {{ receita_liquida|floatformat:2 }}</td>
                </tr>
                <!-- Custos Operacionais -->
                <tr class="hover:bg-gray-50">
                    <td class="py-3 pl-4 text-gray-600">(-) Custos Operacionais</td>
                    <td class="py-3 text-right text-red-600">- R$ {{ custos_operacionais|floatformat:2 }}</td>
                </tr>
                <!-- Lucro Operacional -->
                <tr class="bg-yellow-50 hover:bg-yellow-100">
                    <td class="py-3 font-semibold text-yellow-800">= LUCRO OPERACIONAL</td>
                    <td class="py-3 text-right font-bold {% if lucro_operacional >= 0 %}text-yellow-800{% else %}text-red-600{% endif %} text-lg">
                        R$ {{ lucro_operacional|floatformat:2 }}
                    </td>
                </tr>
                <!-- Despesas Nao Operacionais -->
                <tr class="hover:bg-gray-50">
                    <td class="py-3 pl-4 text-gray-600">(-) Despesas Nao Operacionais (Retiradas)</td>
                    <td class="py-3 text-right text-red-600">- R$ {{ despesas_nao_operacionais|floatformat:2 }}</td>
                </tr>
                <!-- Lucro Liquido -->
                <tr class="{% if lucro_liquido >= 0 %}bg-green-100{% else %}bg-red-100{% endif %}">
                    <td class="py-4 font-bold text-lg {% if lucro_liquido >= 0 %}text-green-800{% else %}text-red-800{% endif %}">
                        = LUCRO LIQUIDO
                    </td>
                    <td class="py-4 text-right font-bold text-xl {% if lucro_liquido >= 0 %}text-green-800{% else %}text-red-800{% endif %}">
                        R$ {{ lucro_liquido|floatformat:2 }}
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Margens -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-500">Margem Bruta</p>
        <div class="flex items-center gap-3 mt-2">
            <div class="flex-1 bg-gray-200 rounded-full h-3">
                <div class="h-3 rounded-full bg-blue-500" style="width: {% if margem_bruta > 100 %}100{% else %}{{ margem_bruta|floatformat:0 }}{% endif %}%"></div>
            </div>
            <span class="font-bold text-lg text-blue-600">{{ margem_bruta|floatformat:1 }}%</span>
        </div>
        <p class="text-xs text-gray-400 mt-1">Receita Liquida / Receita Bruta</p>
    </div>
    <div class="bg-white rounded-lg shadow p-4">
        <p class="text-sm text-gray-500">Margem Liquida</p>
        <div class="flex items-center gap-3 mt-2">
            <div class="flex-1 bg-gray-200 rounded-full h-3">
                <div class="h-3 rounded-full {% if margem_liquida >= 0 %}bg-green-500{% else %}bg-red-500{% endif %}"
                     style="width: {% if margem_liquida > 100 %}100{% elif margem_liquida < 0 %}0{% else %}{{ margem_liquida|floatformat:0 }}{% endif %}%"></div>
            </div>
            <span class="font-bold text-lg {% if margem_liquida >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                {{ margem_liquida|floatformat:1 }}%
            </span>
        </div>
        <p class="text-xs text-gray-400 mt-1">Lucro Liquido / Receita Bruta</p>
    </div>
</div>

<!-- Detalhamento por Categoria -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Entradas -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-sm font-semibold text-gray-500 mb-4">DETALHAMENTO ENTRADAS</h3>
        {% for c in entradas_por_categoria %}
        <div class="flex items-center justify-between py-2 border-b last:border-0">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full" style="background:{{ c.categoria__cor|default:'#6b7280' }}"></span>
                <span class="text-sm">{{ c.categoria__nome|default:"Sem categoria" }}</span>
            </div>
            <span class="text-sm font-semibold text-green-600">R$ {{ c.total|floatformat:2 }}</span>
        </div>
        {% empty %}
        <p class="text-sm text-gray-400">Nenhuma entrada no periodo</p>
        {% endfor %}
    </div>
    <!-- Saidas -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-sm font-semibold text-gray-500 mb-4">DETALHAMENTO SAIDAS</h3>
        {% for c in saidas_por_categoria %}
        <div class="flex items-center justify-between py-2 border-b last:border-0">
            <div class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full" style="background:{{ c.categoria__cor|default:'#6b7280' }}"></span>
                <span class="text-sm">{{ c.categoria__nome|default:"Sem categoria" }}</span>
            </div>
            <span class="text-sm font-semibold text-red-600">R$ {{ c.total|floatformat:2 }}</span>
        </div>
        {% empty %}
        <p class="text-sm text-gray-400">Nenhuma saida no periodo</p>
        {% endfor %}
    </div>
</div>

{% endif %}

<script>
// Atualizar ano ao mudar mes
document.querySelector('select[name="mes"]')?.addEventListener('change', function() {
    const option = this.options[this.selectedIndex];
    const ano = option.dataset.ano;
    if (ano) {
        document.getElementById('ano-input').value = ano;
    }
});
</script>
{% endblock %}
