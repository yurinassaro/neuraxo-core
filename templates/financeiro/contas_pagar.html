{% extends 'base.html' %}

{% block title %}Contas a Pagar - NeuraxoCore{% endblock %}

{% block content %}
<div class="mb-6 flex flex-wrap items-center justify-between gap-4">
    <h1 class="text-2xl font-bold text-gray-800">Contas a Pagar</h1>
    <div class="flex items-center gap-3">
        <form method="get" class="flex items-center gap-2">
            <select name="empresa" onchange="this.form.submit()" class="px-3 py-2 border rounded-lg text-sm">
                {% for e in empresas %}
                <option value="{{ e.id }}" {% if empresa.id == e.id %}selected{% endif %}>{{ e.nome }}</option>
                {% endfor %}
            </select>
        </form>
        <a href="{% url 'dashboard_financeiro' %}" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 text-sm">Voltar</a>
    </div>
</div>

{% if empresa %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- Form nova conta -->
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-lg font-semibold text-gray-700 mb-4">Nova Conta a Pagar</h2>
        <form method="post" class="space-y-3">
            {% csrf_token %}
            <input type="hidden" name="empresa" value="{{ empresa.id }}">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Descrição</label>
                <input type="text" name="descricao" required placeholder="Ex: Internet Vivo" class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Valor (R$)</label>
                <input type="text" name="valor" required placeholder="200,00" class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Categoria (saída)</label>
                <select name="categoria" class="w-full px-3 py-2 border rounded-lg text-sm">
                    <option value="">Sem categoria</option>
                    {% for c in categorias %}
                    <option value="{{ c.id }}">{{ c.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Conta Bancária</label>
                <select name="conta_bancaria" class="w-full px-3 py-2 border rounded-lg text-sm">
                    <option value="">Nenhuma</option>
                    {% for cb in contas_bancarias %}
                    <option value="{{ cb.id }}">{{ cb.nome }}</option>
                    {% endfor %}
                </select>
            </div>
            <!-- Parcelamento -->
            <div class="border rounded-lg p-3 bg-gray-50">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" name="parcelado" id="parcelado" onchange="toggleParcelamento()" class="mr-2 h-4 w-4 text-indigo-600 rounded">
                    <span class="text-sm font-medium text-gray-700">Compra parcelada</span>
                </label>
                <div id="div_parcelas" class="hidden mt-3">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Número de Parcelas</label>
                    <input type="number" name="total_parcelas" id="total_parcelas" min="2" max="48" value="2" class="w-full px-3 py-2 border rounded-lg text-sm">
                    <p class="text-xs text-gray-500 mt-1">O valor informado acima é o TOTAL. Será dividido pelas parcelas.</p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Data do Vencimento</label>
                    <input type="date" name="data_vencimento" id="data_vencimento" required class="w-full px-3 py-2 border rounded-lg text-sm">
                </div>
                <div id="div_recorrencia">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Recorrência</label>
                    <select name="recorrencia" id="recorrencia" class="w-full px-3 py-2 border rounded-lg text-sm">
                        {% for val, label in recorrencias %}
                        {% if val != 'parcelada' %}
                        <option value="{{ val }}" {% if val == 'mensal' %}selected{% endif %}>{{ label }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Dia de Execução (quando pagar)</label>
                <select name="dia_execucao" id="dia_execucao" onchange="toggleDiaExecucaoMensal()" class="w-full px-3 py-2 border rounded-lg text-sm">
                    {% for val, label in dias_execucao %}
                    <option value="{{ val }}">{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div id="div_dia_execucao_mensal" class="hidden">
                <label class="block text-sm font-medium text-gray-700 mb-1">Dia do mês para pagar</label>
                <input type="number" name="dia_execucao_mensal" id="dia_execucao_mensal" min="1" max="31" value="1" class="w-full px-3 py-2 border rounded-lg text-sm">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Observação</label>
                <textarea name="observacao" rows="2" class="w-full px-3 py-2 border rounded-lg text-sm" placeholder="Opcional..."></textarea>
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded-lg hover:bg-indigo-700 text-sm font-semibold">
                Cadastrar Conta
            </button>
        </form>
    </div>

    <!-- Contas recorrentes ativas + itens do mês -->
    <div class="lg:col-span-2 space-y-6">

        <!-- Resumo do mês -->
        <div class="grid grid-cols-3 gap-4">
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-sm text-gray-500">Total Mês</p>
                <p class="text-xl font-bold text-gray-800">R$ {{ total_mes|floatformat:2 }}</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-sm text-gray-500">Pago</p>
                <p class="text-xl font-bold text-green-600">R$ {{ total_pago|floatformat:2 }}</p>
            </div>
            <div class="bg-white rounded-lg shadow p-4 text-center">
                <p class="text-sm text-gray-500">Pendente</p>
                <p class="text-xl font-bold text-red-600">R$ {{ total_pendente|floatformat:2 }}</p>
            </div>
        </div>

        <!-- Itens do mês -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-700">Contas do Mês ({{ hoje|date:"m/Y" }})</h2>
            </div>
            <div class="divide-y">
                {% for item in itens_mes %}
                <div class="p-4 flex items-center justify-between {% if item.pago %}bg-green-50{% elif item.data_execucao < hoje %}bg-red-50{% endif %}">
                    <div class="flex-1">
                        <div class="flex items-center space-x-2">
                            {% if item.pago %}
                            <span class="px-2 py-0.5 text-xs bg-green-100 text-green-800 rounded font-bold">PAGO</span>
                            {% elif item.data_execucao < hoje %}
                            <span class="px-2 py-0.5 text-xs bg-red-100 text-red-800 rounded font-bold">ATRASADO</span>
                            {% elif item.data_execucao == hoje %}
                            <span class="px-2 py-0.5 text-xs bg-orange-100 text-orange-800 rounded font-bold">HOJE</span>
                            {% else %}
                            <span class="px-2 py-0.5 text-xs bg-gray-100 text-gray-600 rounded">PENDENTE</span>
                            {% endif %}
                            {% if item.parcela_numero %}
                            <span class="px-2 py-0.5 text-xs bg-indigo-100 text-indigo-800 rounded">{{ item.parcela_numero }}/{{ item.conta_pagar.total_parcelas }}</span>
                            {% endif %}
                            <span class="font-semibold text-gray-800">{{ item.conta_pagar.descricao }}</span>
                        </div>
                        <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
                            <span>Venc.: {{ item.data_vencimento|date:"d/m/Y" }}</span>
                            <span>Exec.: {{ item.data_execucao|date:"d/m/Y" }}</span>
                            {% if item.pago_em %}
                            <span class="text-green-600">Pago em: {{ item.pago_em|date:"d/m/Y H:i" }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex items-center space-x-3">
                        <span class="font-bold {% if item.pago %}text-green-600{% else %}text-gray-800{% endif %}">
                            R$ {{ item.valor|floatformat:2 }}
                        </span>
                        {% if not item.pago %}
                        <form action="{% url 'pagar_conta' item.id %}" method="post">
                            {% csrf_token %}
                            <button type="submit" class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600"
                                    onclick="return confirm('Marcar como pago e criar lançamento?')">
                                Pagar
                            </button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% empty %}
                <div class="p-8 text-center text-gray-500">
                    Nenhuma conta gerada para este mês. Cadastre uma conta recorrente.
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Lista de contas recorrentes -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-700">Contas Recorrentes Ativas</h2>
            </div>
            <div class="divide-y">
                {% for conta in contas %}
                <div class="p-4 flex items-center justify-between">
                    <div class="flex-1">
                        <h3 class="font-semibold text-gray-800">{{ conta.descricao }}</h3>
                        <div class="flex items-center flex-wrap gap-2 text-xs text-gray-500 mt-1">
                            {% if conta.parcelado and conta.total_parcelas > 1 %}
                            <span class="px-2 py-0.5 bg-indigo-100 text-indigo-800 rounded font-medium">{{ conta.total_parcelas }}x R$ {{ conta.valor|floatformat:2 }}</span>
                            <span class="text-gray-400">(Total: R$ {{ conta.valor_total|floatformat:2 }})</span>
                            {% else %}
                            <span>R$ {{ conta.valor|floatformat:2 }}</span>
                            {% endif %}
                            <span>{{ conta.get_recorrencia_display }}</span>
                            <span>Vence dia {{ conta.dia_vencimento }}</span>
                            <span>{{ conta.get_dia_execucao_display }}</span>
                            {% if conta.categoria %}<span class="px-1.5 py-0.5 rounded" style="background:{{ conta.categoria.cor }}20; color:{{ conta.categoria.cor }}">{{ conta.categoria.nome }}</span>{% endif %}
                        </div>
                        {% if conta.observacao %}
                        <p class="text-xs text-gray-400 mt-1">{{ conta.observacao }}</p>
                        {% endif %}
                    </div>
                    <form action="{% url 'contas_pagar' %}?empresa={{ empresa.id }}" method="post"
                          onsubmit="return confirm('Desativar conta {{ conta.descricao }}?')">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="excluir">
                        <input type="hidden" name="conta_id" value="{{ conta.id }}">
                        <button type="submit" class="px-3 py-1 bg-red-100 text-red-700 text-sm rounded hover:bg-red-200">
                            Desativar
                        </button>
                    </form>
                </div>
                {% empty %}
                <div class="p-8 text-center text-gray-500">
                    Nenhuma conta recorrente cadastrada.
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<script>
function toggleDiaExecucaoMensal() {
    const select = document.getElementById('dia_execucao');
    const div = document.getElementById('div_dia_execucao_mensal');
    if (select && div) {
        if (select.value === 'dia_mes') {
            div.classList.remove('hidden');
        } else {
            div.classList.add('hidden');
        }
    }
}

function toggleParcelamento() {
    const checkbox = document.getElementById('parcelado');
    const divParcelas = document.getElementById('div_parcelas');
    const divRecorrencia = document.getElementById('div_recorrencia');

    if (checkbox && divParcelas) {
        if (checkbox.checked) {
            divParcelas.classList.remove('hidden');
            divRecorrencia.classList.add('hidden');
        } else {
            divParcelas.classList.add('hidden');
            divRecorrencia.classList.remove('hidden');
        }
    }
}

// Executar ao carregar a página
document.addEventListener('DOMContentLoaded', function() {
    toggleDiaExecucaoMensal();
    toggleParcelamento();
});
</script>
{% endblock %}
